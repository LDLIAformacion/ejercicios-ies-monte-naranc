{
  "name": "Auto 06 - Etiquetar Emails Autom√°ticamente con IA",
  "nodes": [
    {
      "parameters": {
        "content": "## üè∑Ô∏è AUTOMATIZACI√ìN 6: Etiquetado Autom√°tico de Emails con IA\n\n### üéØ OBJETIVO:\nCada vez que llega un email nuevo, la IA lo analiza y aplica autom√°ticamente la etiqueta correspondiente en Gmail.\n\n### üìã FLUJO:\n1. Gmail Trigger detecta nuevo email no le√≠do\n2. Se extraen asunto y contenido del email\n3. La IA clasifica el email en una categor√≠a\n4. Gmail aplica la etiqueta correspondiente\n5. (Opcional) Marcar como le√≠do si es informativo\n\n### ‚öôÔ∏è CONFIGURACI√ìN NECESARIA:\n1. **Gmail**: Conectar cuenta de Google\n2. **Etiquetas en Gmail**: Crear previamente:\n   - üè† Familias\n   - üë®‚Äçüè´ Profesorado\n   - üéì Alumnado\n   - üèõÔ∏è Consejer√≠a\n   - üìã Administraci√≥n\n   - ‚ö†Ô∏è Urgente\n   - üì¶ Proveedores\n3. **OpenAI**: Credenciales configuradas\n\n### üè∑Ô∏è CATEGOR√çAS DE ETIQUETAS:\n- **Familias**: Comunicaciones de padres/tutores\n- **Profesorado**: Emails de docentes\n- **Alumnado**: Consultas de estudiantes\n- **Consejer√≠a**: Comunicados oficiales\n- **Administraci√≥n**: Tr√°mites internos\n- **Urgente**: Requiere atenci√≥n inmediata\n- **Proveedores**: Empresas y servicios\n\n### üí° CASOS DE USO:\n- Organizaci√≥n autom√°tica del buz√≥n\n- Priorizaci√≥n visual de emails\n- Filtrado r√°pido por categor√≠a",
        "height": 700,
        "width": 480
      },
      "id": "auto6-note-001",
      "name": "Instrucciones",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [40, 20]
    },
    {
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "mode": "everyMinute"
            }
          ]
        },
        "filters": {
          "readStatus": "unread"
        }
      },
      "id": "auto6-gmail-trigger-001",
      "name": "Gmail - Nuevo Email",
      "type": "n8n-nodes-base.gmailTrigger",
      "typeVersion": 1.2,
      "position": [340, 300]
    },
    {
      "parameters": {
        "mode": "manual",
        "duplicateItem": false,
        "assignments": {
          "assignments": [
            {
              "id": "field-id",
              "name": "email_id",
              "value": "={{ $json.id }}",
              "type": "string"
            },
            {
              "id": "field-remitente",
              "name": "remitente",
              "value": "={{ $json.from.value[0].address }}",
              "type": "string"
            },
            {
              "id": "field-nombre",
              "name": "nombre_remitente",
              "value": "={{ $json.from.value[0].name || $json.from.value[0].address }}",
              "type": "string"
            },
            {
              "id": "field-asunto",
              "name": "asunto",
              "value": "={{ $json.subject }}",
              "type": "string"
            },
            {
              "id": "field-cuerpo",
              "name": "cuerpo",
              "value": "={{ ($json.text || $json.snippet || '').substring(0, 1500) }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "auto6-set-extraer-001",
      "name": "Extraer Datos Email",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [560, 300]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Analiza este email de un instituto de educaci√≥n secundaria y clasif√≠calo:\n\n---\nDE: {{ $json.nombre_remitente }} ({{ $json.remitente }})\nASUNTO: {{ $json.asunto }}\nCONTENIDO: {{ $json.cuerpo }}\n---\n\nClasifica en UNA de estas categor√≠as:\n- Familias: emails de padres, madres o tutores legales\n- Profesorado: emails de docentes del centro o de otros centros\n- Alumnado: emails de estudiantes\n- Consejeria: comunicados de la Consejer√≠a de Educaci√≥n o administraci√≥n educativa\n- Administracion: tr√°mites internos, gestiones administrativas\n- Urgente: si el asunto o contenido indica urgencia o plazos muy cortos\n- Proveedores: empresas, servicios, ofertas comerciales\n\nSi es urgente adem√°s de otra categor√≠a, responde \"Urgente\".\n\nResponde SOLO con el nombre de la categor√≠a en una palabra (sin tildes): Familias, Profesorado, Alumnado, Consejeria, Administracion, Urgente, Proveedores",
        "options": {
          "systemMessage": "Eres un clasificador de emails para un instituto de educaci√≥n secundaria. Tu √∫nica tarea es clasificar emails en categor√≠as predefinidas. Responde SOLO con una palabra que sea el nombre de la categor√≠a. Sin explicaciones."
        }
      },
      "id": "auto6-agent-001",
      "name": "IA - Clasificar Email",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [780, 300]
    },
    {
      "parameters": {
        "model": "gpt-4o-mini",
        "options": {
          "temperature": 0.1
        }
      },
      "id": "auto6-openai-001",
      "name": "OpenAI",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [780, 500]
    },
    {
      "parameters": {
        "jsCode": "// Mapear la clasificaci√≥n de IA a etiquetas de Gmail\nconst items = $input.all();\nconst emailData = $('Extraer Datos Email').first().json;\n\nconst results = [];\n\n// Mapeo de categor√≠as a IDs de etiquetas de Gmail\n// NOTA: Estos IDs deben reemplazarse por los reales de tu cuenta de Gmail\nconst etiquetasMap = {\n  'familias': 'Label_Familias',\n  'profesorado': 'Label_Profesorado',\n  'alumnado': 'Label_Alumnado',\n  'consejeria': 'Label_Consejeria',\n  'administracion': 'Label_Administracion',\n  'urgente': 'Label_Urgente',\n  'proveedores': 'Label_Proveedores'\n};\n\nfor (const item of items) {\n  const clasificacion = (item.json.output || 'administracion').toLowerCase().trim();\n  const etiquetaId = etiquetasMap[clasificacion] || 'Label_Administracion';\n  \n  results.push({\n    json: {\n      email_id: emailData.email_id,\n      clasificacion: clasificacion,\n      etiqueta_id: etiquetaId,\n      asunto: emailData.asunto,\n      remitente: emailData.remitente\n    }\n  });\n}\n\nreturn results;"
      },
      "id": "auto6-code-001",
      "name": "Mapear Etiqueta",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1000, 300]
    },
    {
      "parameters": {
        "operation": "addLabels",
        "messageId": "={{ $json.email_id }}",
        "labelIds": ["={{ $json.etiqueta_id }}"]
      },
      "id": "auto6-gmail-label-001",
      "name": "Gmail - Aplicar Etiqueta",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [1220, 300]
    }
  ],
  "connections": {
    "Gmail - Nuevo Email": {
      "main": [
        [
          {
            "node": "Extraer Datos Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extraer Datos Email": {
      "main": [
        [
          {
            "node": "IA - Clasificar Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IA - Clasificar Email": {
      "main": [
        [
          {
            "node": "Mapear Etiqueta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mapear Etiqueta": {
      "main": [
        [
          {
            "node": "Gmail - Aplicar Etiqueta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI": {
      "ai_languageModel": [
        [
          {
            "node": "IA - Clasificar Email",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {}
}
